name: Send Lark Notification

on:
  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Send to Feishu
        if: github.event.action == 'opened' || github.event.pull_request.merged == true

        run: |
          set -e

          # Âà§Êñ≠ PR ÊòØÂê¶Ë¢´ merged
          PR_MERGED="${{ github.event.pull_request.merged }}"
          if [ "$PR_MERGED" = "true" ]; then
            STATUS="MERGED"
            ACTION_TEXT="ÂΩìÂâçÂä®‰ΩúÔºöMERGEDÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ"
          else
            STATUS="OPENED"
            ACTION_TEXT="ÂΩìÂâçÂä®‰ΩúÔºöOPENEDÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ"
          fi

          # ‰ΩøÁî® jq ÊûÑÈÄ† JSON Ë¥üËΩΩÔºåÂÆâÂÖ®Âú∞Â§ÑÁêÜÁâπÊÆäÂ≠óÁ¨¶
          PAYLOAD=$(jq -n \
            --arg msg_type "interactive" \
            --arg repo_name "${{ github.event.repository.name }}" \
            --arg pr_title "${{ github.event.pull_request.title }}" \
            --arg pr_number "${{ github.event.number }}" \
            --arg pr_author "${{ github.event.pull_request.user.login }}" \
            --arg base_ref "${{ github.event.pull_request.base.ref }}" \
            --arg head_ref "${{ github.event.pull_request.head.ref }}" \
            --arg status "$STATUS" \
            --arg action_text "$ACTION_TEXT" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            '{
              "msg_type": $msg_type,
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": ("PR ÈÄöÁü• - " + $repo_name)
                  },
                  "template": "purple"
                },
                "elements": [
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": false,
                        "text": {
                          "tag": "lark_md",
                          "content": ("‚ú® " + $pr_title)
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("PR #" + $pr_number)
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "plain_text",
                      "content": ("Áî± " + $pr_author + " ÂèëËµ∑ ¬∑ ÂàÜÊîØÔºö" + $base_ref + " -> " + $head_ref)
                    }
                  },
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("Áä∂ÊÄÅÔºöüîî " + $status)
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("‰ΩúËÄÖÔºö" + $pr_author)
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": $action_text
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "Êü•Áúã PR"
                        },
                        "type": "primary",
                        "url": $pr_url
                      },
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "‰ªìÂ∫ì‰∏ªÈ°µ"
                        },
                        "type": "default",
                        "url": $repo_url
                      }
                    ]
                  }
                ]
              }
            }')

          curl -X POST \
            -f \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            ${{secrets.SCIENCEOL_CICD_LARK_WEBHOOK_URL}}
